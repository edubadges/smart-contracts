Type: Endorse Badge
Version: 2.0
Description: Endorse a badge.
Template: {"badge":{"type":"str","desc":"ID van de te endorsen badge.","name":"Badge"},"endorsementComment":{"type":"str","desc":"Comment over deze endorsement.","name":"Comment"}}
Init: YXdhaXQgcXVlcnkoIkNSRUFURSIsICJlbmRvcnNlbWVudGJhZGdlcyIsICIoaWQgQklHSU5UIFBSSU1BUlkgS0VZLCBlbnRpdHkgVkFSQ0hBUigzNSkgTk9UIE5VTEwgUkVGRVJFTkNFUyAiICsNCiAgICAiZW50aXRpZXMoZW50aXR5KSwgYmFkZ2UgVkFSQ0hBUigyNTYpIE5PVCBOVUxMLCBqc29uIEpTT04gTk9UIE5VTEwsIGlzc3VlZF9vbiBCSUdJTlQgTk9UIE5VTEwsIFVOSVFVRSAoZW50aXR5LCBiYWRnZSkpOyIsIFtdKTs=
Code: aWYgKHBheWxvYWQuYmFkZ2UubGVuZ3RoID09PSAwIHx8IHBheWxvYWQuYmFkZ2UubGVuZ3RoID4gMjU2KSB7DQogICAgcmV0dXJuICJJbnZhbGlkIGJhZGdlIGlkLiI7DQp9DQovL0NoZWNrIGlmIHRoZSBlbnRpdHkgZXhpc3RzIGFuZCBpcyBub3QgcmV2b2tlZC4NCmNvbnN0IGVudGl0eSA9IChhd2FpdCBxdWVyeSgiU0VMRUNUIiwgImVudGl0aWVzIiwgIldIRVJFIGVudGl0eSA9ICQxOyIsIFtmcm9tXSkpLnJvd3NbMF07DQppZiAoZW50aXR5ID09PSB1bmRlZmluZWQpIHsNCiAgICByZXR1cm4gIkVudGl0eSBkb2VzIG5vdCBleGlzdHMgb3IgdXNlciBpcyBub3QgYW4gZW50aXR5LiI7DQp9DQppZiAoZW50aXR5LnJldm9rZWQgIT09IG51bGwpIHsNCiAgICByZXR1cm4gIkVudGl0eSBpcyB3aXRoZHJhd24uIjsNCn0NCi8vQ2hlY2sgaWYgdGhlIGluc3RpdHV0aW9uIGlzIG5vdCB3aXRoZHJhd24gKHdlIGFyZSBzdXJlIGl0IGV4aXN0cyBpZiB0aGUgZW50aXR5IGV4aXN0cykNCmNvbnN0IGluc3RpdHV0aW9uID0gKGF3YWl0IHF1ZXJ5KCJTRUxFQ1QiLCAiaW5zdGl0dXRpb25zIiwgIldIRVJFIGluc3RpdHV0aW9uID0gJDE7IiwgW2VudGl0eS5pbnN0aXR1dGlvbl0pKS5yb3dzWzBdOw0KaWYgKGluc3RpdHV0aW9uLnJldm9rZWQgIT09IG51bGwpIHsNCiAgICByZXR1cm4gIkluc3RpdHV0aW9uIG9mIGVudGl0eSBpcyB3aXRoZHJhd24uIjsNCn0NCi8vVGhlIHRoZSB1cmwgb24gd2hpY2ggdGhlIGVuZG9yc2VtZW50IG5lZWRzIHRvIGJlIG1hZGUgYXZhaWxhYmxlDQpjb25zdCB1cmwgPSAoYXdhaXQgcXVlcnkoIlNFTEVDVCIsICJzZXR0aW5ncyIsICJXSEVSRSBrZXkgPSAndXJsJzsiLCBbXSkpLnJvd3NbMF07DQppZiAodXJsID09PSB1bmRlZmluZWQpIHsNCiAgICByZXR1cm4gIlVSTCBub3Qgc2V0IGJ5IFN1cmYuIjsNCn0NCi8vQXNzaWduIGFuIHVuaXF1ZSBpZCB0byB0aGUgZW5kb3JzZW1lbnQgKHdlIGF2b2lkIHVzaW5nIFNFUklBTCBhcyBpdCBkb2Vzbid0IHdvcmsgaW4gY29tYmluYXRpb24gd2l0aCBST0xMQkFDSykNCmNvbnN0IG9sZElkID0gKGF3YWl0IHF1ZXJ5KCJTRUxFQ1QiLCAiZW5kb3JzZW1lbnRiYWRnZXMiLCAiT1JERVIgQlkgaWQgREVTQyBMSU1JVCAxOyIsIFtdKSkucm93c1swXTsNCmNvbnN0IG5ld0lkID0gb2xkSWQgPT09IHVuZGVmaW5lZCA/IDAgOiBvbGRJZC5pZCArIDE7DQovL0NyZWF0ZSB0aGUgZW5kb3JzZW1lbnQganNvbg0KY29uc3QgZW5kb3JzZW1lbnQgPSB7DQogICAgIkBjb250ZXh0IjogImh0dHBzOi8vdzNpZC5vcmcvb3BlbmJhZGdlcy92MiIsDQogICAgInR5cGUiOiAiRW5kb3JzZW1lbnQiLA0KICAgICJpZCI6IGAke3VybC52YWx1ZX1lbmRvcnNlbWVudGJhZGdlPyR7bmV3SWR9YCwNCiAgICAiaXNzdWVyIjogaW5zdGl0dXRpb24uaXJpLA0KICAgICJjbGFpbSI6IHsNCiAgICAgICAgaWQ6IHBheWxvYWQuYmFkZ2UsDQogICAgICAgIGVuZG9yc2VtZW50Q29tbWVudDogcGF5bG9hZC5lbmRvcnNlbWVudENvbW1lbnQNCiAgICB9LA0KICAgICJpc3N1ZWRPbiI6IG5ldyBEYXRlKHByZXZpb3VzQmxvY2tUaW1lc3RhbXApLnRvSVNPU3RyaW5nKCkuc3BsaXQoIi4iKVswXSArICJaIiwNCiAgICAidmVyaWZpY2F0aW9uIjogew0KICAgICAgICB0eXBlOiAiaG9zdGVkIg0KICAgIH0NCn07DQovL0NyZWF0ZSB0aGUgYmFkZ2UNCmNvbnN0IGNyZWF0ZWQgPSBhd2FpdCBxdWVyeSgiSU5TRVJUIiwgImVuZG9yc2VtZW50YmFkZ2VzIiwgIihpZCwgYmFkZ2UsIGVudGl0eSwganNvbiwgaXNzdWVkX29uKSBWQUxVRVMgKCQxLCAkMiwgJDMsICQ0LCAkNSkgIiArDQogICAgIk9OIENPTkZMSUNUIERPIE5PVEhJTkc7IiwgW25ld0lkLCBwYXlsb2FkLmJhZGdlLCBmcm9tLCBKU09OLnN0cmluZ2lmeShlbmRvcnNlbWVudCksIHByZXZpb3VzQmxvY2tUaW1lc3RhbXBdKTsNCmlmIChjcmVhdGVkLnJvd0NvdW50ID09PSAwKSB7DQogICAgcmV0dXJuICJCYWRnZSBhbHJlYWR5IGVuZG9yc2VkIGJ5IGVudGl0eSwgY2Fubm90IHVwZGF0ZSBlbmRvcnNlbWVudC4iOw0KfQ0KcmV0dXJuICJPSyI7

Init as text:
await query("CREATE", "endorsementbadges", "(id BIGINT PRIMARY KEY, entity VARCHAR(35) NOT NULL REFERENCES " +
    "entities(entity), badge VARCHAR(256) NOT NULL, json JSON NOT NULL, issued_on BIGINT NOT NULL, UNIQUE (entity, badge));", []);
Code as text:
if (payload.badge.length === 0 || payload.badge.length > 256) {
    return "Invalid badge id.";
}
//Check if the entity exists and is not revoked.
const entity = (await query("SELECT", "entities", "WHERE entity = $1;", [from])).rows[0];
if (entity === undefined) {
    return "Entity does not exists or user is not an entity.";
}
if (entity.revoked !== null) {
    return "Entity is withdrawn.";
}
//Check if the institution is not withdrawn (we are sure it exists if the entity exists)
const institution = (await query("SELECT", "institutions", "WHERE institution = $1;", [entity.institution])).rows[0];
if (institution.revoked !== null) {
    return "Institution of entity is withdrawn.";
}
//The the url on which the endorsement needs to be made available
const url = (await query("SELECT", "settings", "WHERE key = 'url';", [])).rows[0];
if (url === undefined) {
    return "URL not set by Surf.";
}
//Assign an unique id to the endorsement (we avoid using SERIAL as it doesn't work in combination with ROLLBACK)
const oldId = (await query("SELECT", "endorsementbadges", "ORDER BY id DESC LIMIT 1;", [])).rows[0];
const newId = oldId === undefined ? 0 : oldId.id + 1;
//Create the endorsement json
const endorsement = {
    "@context": "https://w3id.org/openbadges/v2",
    "type": "Endorsement",
    "id": `${url.value}endorsementbadge?${newId}`,
    "issuer": institution.iri,
    "claim": {
        id: payload.badge,
        endorsementComment: payload.endorsementComment
    },
    "issuedOn": new Date(previousBlockTimestamp).toISOString().split(".")[0] + "Z",
    "verification": {
        type: "hosted"
    }
};
//Create the badge
const created = await query("INSERT", "endorsementbadges", "(id, badge, entity, json, issued_on) VALUES ($1, $2, $3, $4, $5) " +
    "ON CONFLICT DO NOTHING;", [newId, payload.badge, from, JSON.stringify(endorsement), previousBlockTimestamp]);
if (created.rowCount === 0) {
    return "Badge already endorsed by entity, cannot update endorsement.";
}
return "OK";